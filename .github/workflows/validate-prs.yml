name: Validate PRs

on:
  pull_request:
    branches: [main, master]

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  lint:
    name: Lint code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest
      - name: Run Biome
        run: biome ci .

  type-check:
    name: Type check
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/dbname' }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 're_dummy_key_for_ci_build' }}
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET || 'dummy_secret_for_ci_build_at_least_32_chars_long' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'
      - name: Create .env for Prisma generate (CI has no repo .env)
        run: |
          echo "DATABASE_URL=${DATABASE_URL:-postgresql://user:pass@localhost:5432/dbname}" > .env
          echo "RESEND_API_KEY=${RESEND_API_KEY:-re_dummy_key_for_ci_build}" >> .env
          echo "BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-dummy_secret_for_ci_build_at_least_32_chars_long}" >> .env
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma client
        run: pnpm --filter @repo/database generate
      - name: Build web app (generates content-collections types)
        run: pnpm --filter @repo/web build
      - name: Run type-check
        run: pnpm -w type-check

  boundary-checks:
    name: UI/DB boundary checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check UI/DB boundary (Slices Plan rule)
        run: |
          echo "Checking UI/DB boundary: apps/web must not import packages/database or prisma..."
          # Exception: next.config.ts uses @prisma/nextjs-monorepo-workaround-plugin (webpack plugin, not runtime)
          if grep -rE "(packages/database|from ['\"]@repo/database|from ['\"]@prisma|from ['\"]prisma)" --include="*.ts" --include="*.tsx" --exclude="next.config.ts" apps/web/; then
            echo "❌ FAIL: Found DB/Prisma imports in apps/web"
            echo "Rule: apps/web must NOT import Prisma or DB internals."
            echo "Use @repo/api procedures or @repo/shared contract types instead."
            exit 1
          fi
          echo "✅ UI/DB boundary OK"
      - name: Check no MSW/mocks in source code
        run: |
          echo "Checking for MSW/mock patterns in source..."
          if grep -rE "(from ['\"]msw['\"]|setupWorker|setupServer)" --include="*.ts" --include="*.tsx" apps/ packages/; then
            echo "❌ FAIL: Found MSW/mock imports in source code"
            echo "Mocks must only be used in tests/ or behind NODE_ENV=development guards."
            exit 1
          fi
          echo "✅ No MSW/mock imports in source"

  build:
    name: Build production
    runs-on: ubuntu-latest
    needs: [lint, type-check, boundary-checks]
    env:
      NODE_ENV: production
      DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/dbname' }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 're_dummy_key_for_ci_build' }}
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET || 'dummy_secret_for_ci_build_at_least_32_chars_long' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'
      - name: Create .env for Prisma generate (CI has no repo .env)
        run: |
          echo "DATABASE_URL=${DATABASE_URL:-postgresql://user:pass@localhost:5432/dbname}" > .env
          echo "RESEND_API_KEY=${RESEND_API_KEY:-re_dummy_key_for_ci_build}" >> .env
          echo "BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-dummy_secret_for_ci_build_at_least_32_chars_long}" >> .env
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma client
        run: pnpm --filter @repo/database generate
      - name: Build (NODE_ENV=production)
        run: pnpm -w build

  prod-mock-ban:
    name: Prod mock ban check
    runs-on: ubuntu-latest
    needs: [build]
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/dbname' }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 're_dummy_key_for_ci_build' }}
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET || 'dummy_secret_for_ci_build_at_least_32_chars_long' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'
      - name: Create .env for Prisma generate (CI has no repo .env)
        run: |
          echo "DATABASE_URL=${DATABASE_URL:-postgresql://user:pass@localhost:5432/dbname}" > .env
          echo "RESEND_API_KEY=${RESEND_API_KEY:-re_dummy_key_for_ci_build}" >> .env
          echo "BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-dummy_secret_for_ci_build_at_least_32_chars_long}" >> .env
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma client
        run: pnpm --filter @repo/database generate
      - name: Build and scan for mocks
        run: pnpm check:prod-mocks

  e2e:
    name: Run e2e tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    needs: [build]
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:pass@localhost:5432/dbname' }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 're_dummy_key_for_ci_build' }}
      BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET || 'dummy_secret_for_ci_build_at_least_32_chars_long' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'
      - name: Create .env for Prisma generate (CI has no repo .env)
        run: |
          echo "DATABASE_URL=${DATABASE_URL:-postgresql://user:pass@localhost:5432/dbname}" > .env
          echo "RESEND_API_KEY=${RESEND_API_KEY:-re_dummy_key_for_ci_build}" >> .env
          echo "BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-dummy_secret_for_ci_build_at_least_32_chars_long}" >> .env
      - name: Install dependencies
        run: pnpm install --frozen-lockfile && pnpm --filter @repo/database generate
      - name: Run Playwright tests
        run: pnpm --filter web e2e:ci
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30
