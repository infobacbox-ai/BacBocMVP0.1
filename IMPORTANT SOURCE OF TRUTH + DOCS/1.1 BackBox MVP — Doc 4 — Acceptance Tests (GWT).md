# **BackBox MVP — Doc 4 — Acceptance Tests (GWT)**

Version : v1.0  
Date : 2026-01-23  
Portée : MVP BackBox (one-run trial, tutorless, no-fallback)

## **Conventions**

* Format : **Given / When / Then** (GWT)  
* Codes d’erreur : **400 / 401 / 403 / 404 / 409 / 429 / 500**.  
  * `400` → `VALIDATION_ERROR`  
  * `401` → `UNAUTHENTICATED`  
  * `403` → `FORBIDDEN`  
  * `404` → `NOT_FOUND`  
  * `409` → `FINAL_REQUIRED`  
  * `429` → `QUOTA_REACHED | RATE_LIMIT | EVALUATION_IN_PROGRESS`  
  * `500` → `INTERNAL_ERROR` (pannes IA : `errorCode=AI_UNAVAILABLE`)  
* “1 retry max” \= une 1ère tentative \+ **un** clic utilisateur « Réessayer » (pas plus).

---

## **A) Accès / Auth / Routing**

**AT-01 — /backbox requiert un accès**

* Given un utilisateur non connecté  
* When il ouvre `/backbox`  
* Then il est redirigé vers `/access`

**AT-01b — /backbox : connecté mais sans entitlement**

* Given un utilisateur connecté dont le trial est consommé et `paid=false`  
* When il ouvre `/backbox`  
* Then il est redirigé vers `/access` (CTA « Passer Premium »)

**AT-02 — API protégée : non connecté**

* Given un utilisateur non connecté  
* When il appelle `saveAnswer` ou `generateMiniRecap` ou `exportHtml`  
* Then l’API répond `401 UNAUTHENTICATED`

**AT-03 — /access n’a pas d’effet “création projet”**

* Given un utilisateur connecté avec essai disponible  
* When il ouvre `/access` puis rafraîchit la page  
* Then aucun projet n’a été créé (pas de `trialProjectId` fixé)

**AT-04 — /access : essai déjà consommé**

* Given un utilisateur connecté dont le trial est consommé  
* When il ouvre `/access`  
* Then l’UI propose « Passer Premium » (et ne propose pas de démarrage d’essai)

---

## **B) Trial one-run : consommation, unicité, no reset**

**AT-05 — Trial consommé à la soumission /backbox/start**

* Given un utilisateur `TRIAL_AVAILABLE`  
* When il soumet un texte sur `/backbox/start`  
* Then le projet trial est créé et `trialProjectId` \+ `consumedAt` sont fixés

**AT-06 — Démarrer le trial deux fois est interdit**

* Given un utilisateur `TRIAL_ACTIVE`  
* When il tente `startTrialProject()`  
* Then l’API répond `403 FORBIDDEN`

**AT-07 — Un seul projet trial**

* Given un utilisateur `TRIAL_ACTIVE`  
* When il tente de créer un 2ᵉ projet (via UI ou API)  
* Then l’action est bloquée (UI désactive « Nouveau texte ») et/ou l’API répond `403 FORBIDDEN`

**AT-08 — No delete reset (même si le projet est supprimé)**

* Given un utilisateur dont le trial a été consommé  
* When le projet trial est supprimé (manuellement ou via une future API)  
* Then l’utilisateur ne récupère pas un essai : `startTrialProject()` reste refusé (403)

**AT-09 — Le projet trial reste consultable**

* Given un utilisateur `TRIAL_ACTIVE` (ou trial consommé **avec projet existant**)  
* When il ouvre le projet trial existant  
* Then l’accès en lecture \+ édition (dans ce projet) reste autorisé

---

## **C) Ownership & Gating “par action”**

**AT-10 — Ownership : lecture interdite**

* Given user A et un projectId appartenant à user B  
* When A appelle `getProject(projectId)`  
* Then `403 FORBIDDEN`

**AT-11 — Ownership : écriture interdite**

* Given user A et un projectId appartenant à user B  
* When A appelle `saveAnswer(projectId, …)`  
* Then `403 FORBIDDEN`

**AT-12 — Trial : actions autorisées uniquement sur trialProjectId**

* Given un utilisateur `TRIAL_ACTIVE` avec `trialProjectId = T`  
* When il appelle `saveAnswer` / `generateMiniRecap` / `exportHtml` sur un autre projectId ≠ T  
* Then `403 FORBIDDEN`

**AT-13 — Project introuvable**

* Given un utilisateur connecté  
* When il appelle `getProject(projectId)` avec un id inexistant  
* Then `404 NOT_FOUND`

---

## **D) Wizard navigation (P1→P4) \+ stepper**

**AT-14 — Pas de saut de pilier non commencé**

* Given un projet dont `currentStep = p1`  
* When l’utilisateur tente d’accéder directement à `/backbox/[projectId]/p3`  
* Then l’UI empêche le saut (stepper verrouillé) et/ou l’app le ramène à un pilier autorisé

**AT-15 — Retour possible sur piliers déjà commencés**

* Given un projet ayant commencé P2  
* When l’utilisateur clique P1 via le stepper  
* Then la navigation vers P1 est autorisée

**AT-16 — Aucun paywall en milieu de wizard**

* Given un utilisateur en trial  
* When il progresse P1 → P4  
* Then aucune étape n’affiche un écran “paywall après P3” ; le parcours va jusqu’au final

---

## **E) Autosave & reprise exacte**

**AT-17 — Autosave sur un pilier**

* Given un utilisateur en P2  
* When il saisit une réponse puis attend la sauvegarde  
* Then la réponse est persistée (lecture via `getProject` inclut la réponse)

**AT-17b — 400 : réponse trop longue (saveAnswer)**

* Given un utilisateur owner sur un projet  
* When il appelle `saveAnswer` avec `content` \> 5 000 caractères  
* Then `400 VALIDATION_ERROR`

**AT-18 — Reprise après refresh**

* Given un utilisateur ayant rempli partiellement P2  
* When il rafraîchit le navigateur  
* Then les champs sont restaurés et l’utilisateur reprend au même endroit

---

## **F) Sidebar (tutorless : questions-guides \+ texte)**

**AT-19 — Sidebar visible sur P1–P4 uniquement**

* Given un utilisateur sur `/p1`…`/p4`  
* When la page charge  
* Then la sidebar (Aide \+ TEXTE) est visible

**AT-20 — Pas de sidebar requise sur mini-récaps et final**

* Given un utilisateur sur `/p2/recap` ou `/final`  
* When la page charge  
* Then la sidebar n’est pas affichée (ou est masquée)

**AT-21 — Aide \= pas de chat**

* Given un utilisateur sur un pilier  
* When il inspecte la sidebar “Aide”  
* Then il n’existe aucun champ “message”, aucun bouton “envoyer”, aucun historique

---

## **G) Mini-récaps : succès, quotas, rate-limit, concurrence**

**AT-22 — Générer un mini-récap (succès)**

* Given un utilisateur owner sur un pilier P1  
* When il clique « Évaluer cette étape »  
* Then un mini-récap est généré et affiché sur `/p1/recap`

**AT-23 — Quota trial : 2 évaluations max par pilier**

* Given un projet trial  
* When l’utilisateur génère 2 mini-récaps sur le même pilier (évaluer \+ améliorer)  
* Then les 2 réussissent

**AT-24 — Quota trial : 3e tentative bloquée**

* Given un projet trial ayant déjà 2 évaluations réussies sur P1  
* When l’utilisateur tente une 3e génération  
* Then l’API répond `429 QUOTA_REACHED` et l’UI affiche un CTA « Passer Premium »

**AT-24b — PAID : pas de quota 2/pilier**

* Given un utilisateur `PAID`  
* When il génère \> 2 mini-récaps sur le même pilier  
* Then l’API ne renvoie pas `429 QUOTA_REACHED` (la génération reste autorisée)

**AT-25 — Quota trial : consommé uniquement sur succès**

* Given un projet trial avec compteur P2 \= 1  
* When une génération P2 échoue (IA indisponible)  
* Then le compteur P2 ne s’incrémente pas

**AT-26 — Rate-limit : 10 évaluations/heure/user (trial & paid)**

* Given un utilisateur (trial ou paid)  
* When il effectue \> 10 invocations d’évaluation (mini-récap/final), **y compris retries et échecs**, en \< 1h  
* Then l’API répond `429 RATE_LIMIT`

**AT-27 — Rate-limit : l’upgrade ne doit pas être proposé comme “solution”**

* Given une erreur `429 RATE_LIMIT`  
* When l’UI affiche l’état d’erreur  
* Then l’UI propose « Réessayer » / « Réessayer plus tard » (pas “Passer Premium” comme remède)

**AT-28 — Concurrence : évaluation déjà en cours**

* Given un lock actif sur (userId, projectId, pillar)  
* When l’utilisateur déclenche une 2e évaluation simultanée sur le même pilier  
* Then `429 EVALUATION_IN_PROGRESS` et l’UI indique « Évaluation déjà en cours »

---

## **H) Panne IA : no-fallback \+ 1 retry max**

**AT-29 — 1er échec IA : proposer “Réessayer”**

* Given une tentative de génération mini-récap qui échoue  
* When l’UI reçoit `500` avec `errorCode=AI_UNAVAILABLE`  
* Then l’UI affiche un bouton « Réessayer »

**AT-30 — 2e échec IA (après retry) : écran IA indisponible**

* Given un 2e échec IA après avoir cliqué « Réessayer »  
* When l’UI affiche l’erreur  
* Then l’écran « IA indisponible » apparaît avec uniquement : « Réessayer plus tard » \+ « Retour au pilier »

**AT-30b — “Réessayer plus tard” \= pas de retry immédiat**

* Given l’écran « IA indisponible » affiché après 1 retry max  
* When l’utilisateur clique « Réessayer plus tard »  
* Then l’app revient au pilier sans relancer une génération IA automatiquement

**AT-31 — Aucun chemin “Continuer sans IA”**

* Given une panne IA  
* When l’utilisateur cherche une action alternative  
* Then il n’existe aucun bouton/flow « Continuer sans IA » (nulle part dans l’app)

---

## **I) Final recap \+ Export HTML**

**AT-32 — Générer le récap final (trial & paid)**

* Given un utilisateur owner (trial ou paid) avec des mini-récaps P1–P4 disponibles  
* When il clique « Générer récap final »  
* Then un `finalRecap` est créé et affiché sur `/final`

**AT-32b — Final : refus si mini-récaps manquants (optionnel)**

* Given un projet où au moins un mini-récap P1–P4 est manquant  
* When l’utilisateur clique « Générer récap final »  
* Then `409 VALIDATION_ERROR` (ou `409 FINAL_REQUIRED_RECAPS`) et l’UI indique quels piliers manquent

**AT-33 — Export interdit sans finalRecap**

* Given un projet sans `finalRecap`  
* When l’utilisateur clique « Imprimer / Export HTML »  
* Then `409 FINAL_REQUIRED` et l’UI propose « Générer récap final »

**AT-34 — Export autorisé avec finalRecap**

* Given un projet avec `finalRecap`  
* When l’utilisateur clique « Imprimer / Export HTML »  
* Then l’API renvoie un HTML (trial & paid)

**AT-35 — Final : action “recommencer” \= PAID only**

* Given un utilisateur TRIAL  
* When il est sur `/final`  
* Then le bouton « Recommencer avec un autre texte » n’est pas présent et est remplacé par « Passer Premium »

---

## **J) Validation inputs & erreurs UI**

**AT-36 — 400 : texte invalide / trop long**

* Given un utilisateur sur `/backbox/start`  
* When il soumet un texte vide ou \> 30 000 caractères  
* Then `400 VALIDATION_ERROR` et l’UI indique que le texte est invalide/trop long

**AT-37 — 404 : projet introuvable**

* Given un utilisateur connecté  
* When il ouvre un `projectId` inexistant  
* Then l’UI affiche l’état “Projet introuvable” \+ CTA retour dashboard

**AT-38 — 403 : accès refusé**

* Given un utilisateur connecté  
* When il ouvre un projet qui ne lui appartient pas  
* Then l’UI affiche l’état “Accès refusé” \+ CTA retour dashboard

---

## **K) Upgrade (minimum attendu)**

**AT-39 — Upgrade : débloque multi-projets**

* Given un utilisateur qui devient PAID via Stripe  
* When l’entitlement passe à `paid`  
* Then « Nouveau texte » est activé sur le dashboard et la création multi-projets est possible

**AT-40 — Upgrade : ne change pas l’historique trial**

* Given un utilisateur qui a consommé son essai  
* When il devient PAID  
* Then `consumedAt` et `trialProjectId` restent inchangés (pas de reset)

